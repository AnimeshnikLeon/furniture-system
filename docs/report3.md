# Отчёт по заданию 3 (интерфейс подсистемы продукции)

## Цель

Разработать пользовательский интерфейс программного модуля для работы с продукцией мебельной компании, обеспечивающий:

- последовательную навигацию между страницами (включая возврат «Назад»);
- просмотр списка продукции и цехов;
- добавление/редактирование продукции в отдельной форме;
- обработку исключительных ситуаций и информирование пользователя;
- валидацию данных (в т.ч. цена с точностью до сотых, неотрицательная);
- единый стиль оформления (шапка/меню/футер), соответствующий макету и требованиям.

Интерфейс реализован как HTML‑UI поверх FastAPI (Jinja2 + CSS), без отдельного SPA‑фронтенда. Такой вариант соответствует заданию: приложение состоит из страниц, между которыми есть переходы, формы, валидация и сообщения.

---

## 1. Выбор стека и обоснование

Использовано:

- **FastAPI** — уже применяется в проекте для бэкенда, удобно совмещать API и HTML‑страницы.
- **Jinja2Templates** — серверный рендеринг страниц, простая интеграция с FastAPI.
- **HTML + CSS** — минимальная зависимость от дополнительных фронтенд‑фреймворков, легче обеспечить «единый внешний вид» и быстро реализовать формы/таблицы.

Плюс: интерфейс работает в одной кодовой базе и сразу использует данные из PostgreSQL через SQLAlchemy.

---

## 2. Реализованные страницы и навигация

### 2.1. Общий каркас (layout)

Файл: `app/templates/base.html` + стили `app/static/style.css`.

В каркасе реализованы обязательные элементы:

- **Header**: название организации + логотип из `/static/logo.png`.
- **Sidebar (меню)**: переключение страниц:
  - «Продукция» → `/ui/products`
  - «Цеха» → `/ui/workshops`
- **Footer**: `© 2006–2025 Мебельная компания`.
- **Единый визуальный стиль** (цветовая схема, типографика, таблицы, формы, кнопки).

Корневая страница `/` перенаправляет на основной экран подсистемы:
- `GET /` → редирект на `/ui/products`.

### 2.2. Продукция

1) **Список продукции**  
Маршрут: `GET /ui/products`  
Шаблон: `app/templates/products.html`

Отображается таблица со столбцами:

- Тип продукции
- Наименование
- Артикул
- Минимальная стоимость для партнёра
- Основной материал
- Время изготовления (ч)
- Действия (редактировать/удалить)

Также есть кнопка **«Добавить продукт»** → `/ui/products/new`.

2) **Добавление продукции**  
Маршрут: `GET /ui/products/new`  
Шаблон: `app/templates/product_form.html`

3) **Редактирование продукции**  
Маршрут: `GET /ui/products/{product_id}/edit`  
Шаблон: `app/templates/product_form.html`

Переход на редактирование реализован нажатием на действие **«Редактировать»** у конкретной строки продукта.

На форме предусмотрена кнопка **«Назад к списку»** → `/ui/products`.

### 2.3. Цеха

1) **Список цехов**  
Маршрут: `GET /ui/workshops`  
Шаблон: `app/templates/workshops.html`

Есть кнопка **«Добавить цех»** → `/ui/workshops/new`.

2) **Добавление/редактирование цеха**  
Маршруты:
- `GET /ui/workshops/new`
- `GET /ui/workshops/{workshop_id}/edit`  
Шаблон: `app/templates/workshop_form.html`

---

## 3. Форма добавления/редактирования продукции (требования задания)

Форма для продукции реализована единым шаблоном `product_form.html` и обработчиком сохранения:

- `POST /ui/products/save`

### 3.1. Поля формы (как в задании)

На форме предусмотрены поля:

- **Артикул** (строка, обязательное)
- **Тип продукта** (select, обязательное; значения из таблицы `product_type`)
- **Наименование** (строка, обязательное)
- **Минимальная стоимость для партнёра** (decimal, обязательное)
- **Основной материал** (select, обязательное; значения из таблицы `material_type`)

### 3.2. Загрузка данных при редактировании

При открытии `/ui/products/{id}/edit`:

- запись продукта извлекается из БД;
- значения полей подставляются в форму (`form_data`), включая выбранные значения в выпадающих списках.

### 3.3. Обновление списка после сохранения

После успешного сохранения (создание или обновление):

- выполняется редирект на `/ui/products?status=...`;
- список отображается заново уже с актуальными данными;
- пользователю показывается сообщение об успехе (через `build_status_messages`).

---

## 4. Валидация и обработка исключительных ситуаций

### 4.1. Серверная валидация (обязательная)

В обработчике `ui_product_save` выполняется проверка:

- обязательность `name` и `article`;
- корректность выбора справочников (`product_type_id`, `material_type_id`) — должны быть целыми > 0;
- **цена**:
  - допускаются `,` и `.` как разделитель;
  - значение не может быть отрицательным;
  - сохраняется с точностью до сотых (`Decimal("0.01")`).

При ошибках:

- форма возвращается с HTTP 400;
- рядом с полем отображается подсказка (`field_errors[...]`);
- сверху выводится суммарное сообщение «Ошибка ввода данных».

### 4.2. Пользовательские уведомления и запретные действия

Механизм сообщений реализован через query‑параметр `status` и функцию:

- `build_status_messages(request)`

Примеры ситуаций:

- попытка отредактировать/удалить несуществующий продукт → редирект на список с `status=product_not_found`;
- успешное создание/обновление/удаление → `product_created / product_updated / product_deleted`.

Сообщения в интерфейсе визуально различаются по типу:

- `success` / `info` / `warning` / `error`

и отображаются в `base.html` единообразно.

### 4.3. Предупреждение о необратимых операциях

Удаление продукта и цеха выполняется через POST‑формы, дополнительно на клиенте есть подтверждение:

- функция `confirmDeletion(...)` в `base.html`
- `onsubmit="return confirmDeletion('...')"`

Текст предупреждает, что операция необратима.

### 4.4. Обработка ошибок БД (IntegrityError)

При сохранении продукта/цеха обработаны конфликты уникальности:

- отлавливается `IntegrityError`;
- транзакция откатывается (`db.rollback()`);
- пользователю показывается понятное сообщение, что данные дублируются и что сделать (изменить значения и повторить).

---

## 5. Расчёт времени изготовления в интерфейсе

На странице списка продукции выводится **время изготовления** как целое неотрицательное число.

Расчёт реализован в серверной части (используется и UI, и JSON‑API):

- эндпоинт/функция `list_product_cards()` (см. `app/main.py`)
- суммирование `production_time_hours` по всем связанным цехам;
- округление вверх до целого часа (`ceil`);
- если цехов нет, время = 0.

В UI это отображается в столбце «Время изготовления, ч».

---

## 6. Комментарии в коде

Комментарии добавлены точечно:

- для пояснения неочевидных мест (например, назначение функций парсинга/валидации, подтверждение удаления);
- без избыточных комментариев к очевидным строкам.

---

## 7. Проверка работы (что тестировалось)

Проверено вручную через браузер:

1. Переходы:
   - `/` → `/ui/products`
   - меню sidebar: «Продукция» ↔ «Цеха»
   - кнопки «Добавить», «Назад к списку», «Редактировать».

2. Продукция:
   - добавление продукта с корректными данными;
   - ошибки ввода (пустые поля, неверная цена, отрицательная цена);
   - редактирование существующего продукта (поля предзаполняются);
   - удаление (подтверждение + обновление списка).

3. Цеха:
   - добавление/редактирование с валидацией (число сотрудников > 0);
   - удаление с подтверждением;
   - обработка ситуации «цех не найден».

Приложение не завершается аварийно: ошибки пользователя обрабатываются сообщениями и возвратом формы.

---

## 8. Где находятся результаты задания 3 в проекте

- UI‑маршруты: `app/main.py` (раздел «HTML‑интерфейс (задание 3)»)
- Шаблоны:
  - `app/templates/base.html`
  - `app/templates/products.html`
  - `app/templates/product_form.html`
  - `app/templates/workshops.html`
  - `app/templates/workshop_form.html`
- Стили: `app/static/style.css`
- Статические ресурсы (иконка/логотип): каталог `app/static/` (используются в `base.html`)
