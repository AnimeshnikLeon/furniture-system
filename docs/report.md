# Отчёт о разработке подсистемы продукции мебельной компании

## Выбор СУБД

Использована PostgreSQL 16:

- промышленный стандарт, поддерживает внешние ключи, ограничения целостности;
- удобные инструменты для ER‑диаграмм (pgAdmin, DBeaver);
- хорошо интегрируется с Python (SQLAlchemy).

## Шаги разработки

1. **Анализ данных**

   - На основе `*_import.xlsx` выделены сущности:
     - тип продукции,
     - тип материала,
     - тип цеха,
     - цех,
     - продукция,
     - маршрут «продукт–цех» с временем изготовления.
   - Определены связи:
     - `product -> product_type`, `product -> material_type`,
     - `workshop -> workshop_type`,
     - `product_workshop -> product`, `product_workshop -> workshop`.
2. **Проектирование схемы (3НФ)**

   - Все повторяющиеся строковые значения вынесены в отдельные справочники.
   - В таблицах только атрибуты, напрямую зависящие от первичного ключа.
   - Заданы первичные и внешние ключи, `UNIQUE` для бизнес‑ключей (названия, артикулы).
3. **Реализация БД**

   - Подготовлен скрипт `db/init.sql`, который:
     - создаёт таблицы `product_type`, `material_type`, `workshop_type`,
       `workshop`, `product`, `product_workshop`;
     - настраивает связи и ограничения целостности.
   - Скрипт автоматически выполняется контейнером PostgreSQL при старте
     (`docker-entrypoint-initdb.d`).
4. **Подготовка и импорт данных**

   - Написан `scripts/import_data.py`:
     - читает Excel (`pandas`, `openpyxl`);
     - конвертирует числа в формате `3,5` и проценты в `Decimal`;
     - загружает данные в правильном порядке:
       1. `product_type`,
       2. `material_type`,
       3. `workshop_type` и `workshop`,
       4. `product`,
       5. `product_workshop`;
     - использует `ON CONFLICT` для безопасного повторного запуска.
   - Импорт выполняется отдельным Docker‑сервисом `importer` после старта БД.
5. **Разработка сервисного слоя**

   - Создано FastAPI‑приложение (`app/`), использующее SQLAlchemy ORM.
   - Реализованы эндпоинты:
     - `GET /products` — список продукции;
     - `POST /products` — добавление продукции;
     - `PUT /products/{id}` — редактирование продукции;
     - `GET /workshops` — список цехов;
     - `GET /products/{id}/workshops` — список цехов по маршруту с временем.
   - Модели БД и Pydantic‑схемы описаны в файлах `models.py` и `schemas.py`.
6. **ER‑диаграмма**

В СУБД можно сгенерировать ER‑диаграмму:

- в pgAdmin: Tools → ERD Tool → импорт схемы public → экспорт в PDF;
- в DBeaver: Database → New ER Diagram → Print Diagram → PDF.

Полученный файл следует сохранить как `docs/er_diagram.pdf`.
В репозитории оставлен файл‑заглушка `er_diagram_placeholder.txt`, который
можно заменить готовым PDF. (Честно говоря, не нашёл как создавать именно в PDF в pgAdmin 4)

7. **Развёртывание**

- Файл `docker-compose.yml` описывает три сервиса: `db`, `importer`, `app`.
- Одна команда `docker-compose up --build` разворачивает:
  - базу данных,
  - загрузку данных,
  - API‑сервис.
