# Отчёт по заданию 4 (цеха по продукту и расчёт сырья)

## Цель

Дополнить подсистему работы с продукцией:

- реализовать вывод списка цехов, участвующих в производстве конкретного продукта;
- интегрировать страницу в существующий интерфейс;
- разработать единый метод расчёта количества сырья с учётом потерь;
- предоставить этот метод для использования из других систем.

---

## 1. Страница «Цеха для продукции»

### 1.1. Маршрут и логика

Добавлен HTML‑маршрут:

- `GET /ui/products/{product_id}/workshops`

Реализован в `app/main.py` функцией `ui_product_workshops`:

- по `product_id` считывается продукт;
- если продукт не найден — редирект на `/ui/products?status=product_not_found`;
- по таблице `product_workshop` и `workshop` получаются:
  - название цеха,
  - тип цеха,
  - требуемое количество сотрудников (`workers_required`),
  - время нахождения продукции в данном цехе (`production_time_hours`);
- считается суммарное время по всем цехам (в часах, округление вверх).

### 1.2. Шаблон страницы

Создан шаблон `app/templates/product_workshops.html`:

- в шапке показывается:
  - тип продукции, наименование, артикул;
  - минимальная стоимость для партнёра;
  - основной материал;
  - суммарное время изготовления;
- ниже — таблица со столбцами:
  - «Название цеха»,
  - «Тип цеха»,
  - «Требуемое количество сотрудников»,
  - «Время в цехе, ч»;
- при отсутствии данных выводится понятное сообщение;
- есть кнопка «Назад к продукции» (возврат на `/ui/products`).

Страница использует уже существующие стили (`data-table`, `form-card` и др.),
поэтому внешний вид полностью согласован с остальным приложением.

### 1.3. Переход из списка продукции

В шаблоне `app/templates/products.html` добавлена ссылка‑действие:

- рядом с «Редактировать»/«Удалить» появилась ссылка **«Цеха»**,
  ведущая на `/ui/products/{id}/workshops`.

Таким образом, пользователь может для любого изделия открыть список цехов,
в которых оно изготавливается, и увидеть время по каждому шагу маршрута.

---

## 2. Метод расчёта количества сырья

### 2.1. Сервисный метод

Создан модуль `app/services.py` с функцией:

```python
calculate_raw_material_amount(
    db: Session,
    product_type_id: int,
    material_type_id: int,
    quantity: int,
    param1: float,
    param2: float,
) -> int
```

Функция:

1. Проверяет входные данные:
   - `quantity` — целое > 0;
   - `param1`, `param2` — положительные вещественные;
   - указанные `product_type_id` и `material_type_id` существуют в БД.
2. Загружает:
   - `coefficient` из таблицы `product_type`,
   - `loss_percent` из `material_type` (хранится как доля: 0.05 = 5%).
3. Рассчитывает:
   - сырьё на одну единицу:
     `per_unit = param1 * param2 * coefficient`;
   - сырьё на всё количество:
     `total_without_losses = per_unit * quantity`;
   - учитывает потери:
     `total_with_losses = total_without_losses * (1 + loss_percent)`.
4. Возвращает целое количество сырья,
   округлённое **вверх** до ближайшего целого (используется `ROUND_CEILING`).

При любой ошибке (неподходящие данные, отсутствующие типы и т.п.)
метод возвращает `-1`, как требуется в задании.

Этот модуль можно вынести в отдельный репозиторий
(репозиторий с тем же названием, что и проект) без изменений логики.

### 2.2. REST‑обёртка

Для удобства интеграции добавлен REST‑эндпоинт:

- `POST /calculate-raw-material`

Схемы в `app/schemas.py`:

```python
class RawMaterialCalcRequest(BaseModel):
    product_type_id: int
    material_type_id: int
    quantity: int
    param1: float
    param2: float

class RawMaterialCalcResult(BaseModel):
    result: int
```

Эндпоинт вызывает `services.calculate_raw_material_amount` и возвращает результат.
Таким образом, любой внешний модуль может выполнить расчёт через HTTP
или напрямую использовать функцию из `services.py`.
